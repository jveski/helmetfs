name: Soak Test

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Test duration (e.g., 5m, 1h)'
        required: false
        default: '10m'
      concurrency:
        description: 'Number of concurrent workers'
        required: false
        default: '4'
      seed:
        description: 'Random seed (0 = use current time)'
        required: false
        default: '0'
      corrupt_rate:
        description: 'Probability of corrupting a blob (0-1, e.g., 0.01)'
        required: false
        default: '0'
  schedule:
    - cron: '0 3 * * *'

jobs:
  soak:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build HelmetFS
        run: go build -o helmetfs .

      - name: Start HelmetFS
        run: |
          ./helmetfs -addr :8080 &
          sleep 2

      - name: Run soak test
        run: |
          cd soaktest
          go run . \
            -url http://localhost:8080 \
            -duration ${{ github.event.inputs.duration || '10m' }} \
            -concurrency ${{ github.event.inputs.concurrency || '4' }} \
            -seed ${{ github.event.inputs.seed || '0' }} \
            -blobs ../blobs \
            -corrupt-rate ${{ github.event.inputs.corrupt_rate || '0' }} \
            -report ${{ runner.temp }}/soak-report.md

      - name: Write test report to summary
        if: always()
        run: |
          if [ -f "${{ runner.temp }}/soak-report.md" ]; then
            cat "${{ runner.temp }}/soak-report.md" >> $GITHUB_STEP_SUMMARY
          else
            echo "# ⚠️ Soak Test Report Not Generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The soak test did not produce a report. Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
          fi
