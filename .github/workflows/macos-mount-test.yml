name: macOS Smoke Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  mount-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build HelmetFS
        run: go build -o helmetfs .

      - name: Start HelmetFS
        run: |
          ./helmetfs -addr :8080 &
          sleep 2

      - name: Mount WebDAV share
        run: |
          mkdir -p /tmp/helmetfs-mount
          mount_webdav -S http://localhost:8080/ /tmp/helmetfs-mount

      - name: Run CRUD tests
        run: |
          MOUNT=/tmp/helmetfs-mount

          # Test 1: Create and read a file
          echo "hello world" > "$MOUNT/test.txt"
          content=$(cat "$MOUNT/test.txt")
          [ "$content" = "hello world" ] || { echo "FAIL: Create/Read test"; exit 1; }
          echo "PASS: Create/Read test"

          # Test 2: Update file
          echo "updated content" > "$MOUNT/test.txt"
          content=$(cat "$MOUNT/test.txt")
          [ "$content" = "updated content" ] || { echo "FAIL: Update test"; exit 1; }
          echo "PASS: Update test"

          # Test 3: Delete file
          rm "$MOUNT/test.txt"
          [ ! -f "$MOUNT/test.txt" ] || { echo "FAIL: Delete test"; exit 1; }
          echo "PASS: Delete test"

          # Test 4: Directory operations
          mkdir "$MOUNT/testdir"
          [ -d "$MOUNT/testdir" ] || { echo "FAIL: Mkdir test"; exit 1; }
          echo "PASS: Mkdir test"

          echo "file in dir" > "$MOUNT/testdir/nested.txt"
          content=$(cat "$MOUNT/testdir/nested.txt")
          [ "$content" = "file in dir" ] || { echo "FAIL: Nested file test"; exit 1; }
          echo "PASS: Nested file test"

          rm -r "$MOUNT/testdir"
          [ ! -d "$MOUNT/testdir" ] || { echo "FAIL: Rmdir test"; exit 1; }
          echo "PASS: Rmdir test"

          # Test 5: Larger file (100KB to test blob handling)
          dd if=/dev/urandom bs=1024 count=100 2>/dev/null | base64 > "$MOUNT/large.txt"
          [ -s "$MOUNT/large.txt" ] || { echo "FAIL: Large file create test"; exit 1; }
          rm "$MOUNT/large.txt"
          [ ! -f "$MOUNT/large.txt" ] || { echo "FAIL: Large file delete test"; exit 1; }
          echo "PASS: Large file test"

          # Test 6: Filename with spaces
          echo "special" > "$MOUNT/file with spaces.txt"
          content=$(cat "$MOUNT/file with spaces.txt")
          [ "$content" = "special" ] || { echo "FAIL: Filename with spaces test"; exit 1; }
          rm "$MOUNT/file with spaces.txt"
          echo "PASS: Filename with spaces test"

          echo "All CRUD tests passed!"

      - name: Cleanup
        if: always()
        run: |
          diskutil unmount /tmp/helmetfs-mount || true
          pkill helmetfs || true
